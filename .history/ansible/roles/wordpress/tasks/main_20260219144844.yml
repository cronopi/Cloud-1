# WordPress - Despliegue completo con Docker Compose
# Requisitos Cloud-1:
# - Sitio WordPress con persistencia de datos
# - Reinicio autom√°tico en reboot
# - TLS/HTTPS
# - Redirecciones seg√∫n URL
# - phpMyAdmin para administraci√≥n de BD


# Crear estructura de directorios para datos persistentes
- name: Crear directorio para datos MySQL
  file:
    path: "{{ playbook_dir }}/data/mysql"
    state: directory
    mode: '0755'
  # Los datos de MySQL se guardan aqui

- name: Crear directorio para datos WordPress
  file:
    path: "{{ playbook_dir }}/data/wordpress"
    state: directory
    mode: '0755'
  # Los archivos de WordPress (temas, plugins, uploads)
  # Datos: im√°genes, usuarios, art√≠culos

# ==============================================================================
# PASO 2: Verificar que docker-compose.yml existe
# ==============================================================================

- name: Verificar que docker-compose.yml existe en el proyecto
  stat:
    path: "{{ playbook_dir }}/docker-compose.yml"
  register: docker_compose_file

- name: Fallar si docker-compose.yml no existe
  fail:
    msg: "ERROR: docker-compose.yml no encontrado en {{ playbook_dir }}/"
  when: not docker_compose_file.stat.exists
  # Usa el docker-compose.yml existente, no crea uno nuevo

# ==============================================================================
# PASO 4: Levantar contenedores con docker-compose
# ==============================================================================

- name: Levantar contenedores Docker Compose
  shell: |
    cd {{ playbook_dir }}
    docker-compose up -d
  register: docker_compose_result
  # Genera todos los contenedores (mysql, wordpress, nginx, phpmyadmin)

- name: Mostrar resultado
  debug:
    msg: "{{ docker_compose_result.stdout_lines }}"

# ==============================================================================
# PASO 5: Validar que los contenedores est√°n corriendo
# ==============================================================================

- name: Esperar a que MySQL est√© listo
  wait_for:
    host: localhost
    port: 3306
    delay: 5
    timeout: 60
  ignore_errors: yes
  # Espera hasta 60 segundos a que MySQL est√© listo

- name: Esperar a que WordPress est√© listo
  wait_for:
    host: localhost
    port: 9000
    delay: 5
    timeout: 60
  ignore_errors: yes

- name: Esperar a que nginx est√© listo
  wait_for:
    host: localhost
    port: 80
    delay: 5
    timeout: 60
  ignore_errors: yes

- name: Verificar estado de contenedores
  shell: docker ps --format "table {{.Names}}\t{{.Status}}"
  register: docker_status
  changed_when: false

- name: Mostrar estado de contenedores
  debug:
    msg: "{{ docker_status.stdout_lines }}"
  # Verifica que todos los contenedores est√°n corriendo

# ==============================================================================
# PASO 6: Informaci√≥n de acceso
# ==============================================================================

- name: Mostrar instrucciones de acceso
  debug:
    msg:
      - "=========================================="
      - "‚úÖ WordPress desplegado correctamente"
      - "=========================================="
      - ""
      - "üìç Accesos disponibles:"
      - "   - WordPress: http://localhost (o tu dominio)"
      - "   - phpMyAdmin: http://localhost:8080"
      - "   - Usuario MySQL: 42user"
      - "   - Contrase√±a MySQL: wppassword"
      - ""
      - "üìä Ver logs de contenedor MySQL:"
      - "   docker logs mysql"
      - ""
      - "üìä Ver logs de contenedor WordPress:"
      - "   docker logs wordpress"
      - ""
      - "üìä Ver logs de contenedor nginx:"
      - "   docker logs nginx"
      - ""
      - "üîÑ Reiniciar servicios:"
      - "   docker-compose restart"
      - ""
      - "üõë Detener servicios:"
      - "   docker-compose down"
      - "=========================================="
