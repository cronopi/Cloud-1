# WordPress - Despliegue completo con Docker Compose
# Requisitos Cloud-1:
# - Sitio WordPress con persistencia de datos
# - Reinicio automático en reboot
# - TLS/HTTPS
# - Redirecciones según URL
# - phpMyAdmin para administración de BD

# ==============================================================================
# PASO 1: Verificar estructura de directorios
# ==============================================================================

- name: Verificar que ./data/mysql existe
  stat:
    path: "{{ playbook_dir }}/../data/mysql"
  register: data_mysql_dir

- name: Advertencia si ./data/mysql no existe
  debug:
    msg: "⚠️ Directorio ./data/mysql no encontrado. Crea la estructura manualmente."
  when: not data_mysql_dir.stat.exists

- name: Verificar que ./data/wordpress existe
  stat:
    path: "{{ playbook_dir }}/../data/wordpress"
  register: data_wordpress_dir

- name: Advertencia si ./data/wordpress no existe
  debug:
    msg: "⚠️ Directorio ./data/wordpress no encontrado. Crea la estructura manualmente."
  when: not data_wordpress_dir.stat.exists

# ==============================================================================
# PASO 2: Verificar que docker-compose.yml existe
# ==============================================================================

- name: Verificar que docker-compose.yml existe en el proyecto
  stat:
    path: "{{ playbook_dir }}/../docker-compose.yml"
  register: docker_compose_file

- name: Fallar si docker-compose.yml no existe
  fail:
    msg: "ERROR: docker-compose.yml no encontrado en {{ playbook_dir }}/../"
  when: not docker_compose_file.stat.exists
  # Usa el docker-compose.yml existente, no crea uno nuevo

# ==============================================================================
# PASO 3: Verificar que .env existe
# ==============================================================================

- name: Verificar que .env existe en el proyecto
  stat:
    path: "{{ playbook_dir }}/../.env"
  register: env_file

- name: Fallar si .env no existe
  fail:
    msg: |
      ERROR: archivo .env no encontrado.

      Crear .env con las variables de configuración:
      1. cp .env.example .env
      2. Editar .env con tus credenciales
      3. Volver a ejecutar el playbook
  when: not env_file.stat.exists

# ==============================================================================
# PASO 4: Verificar que certificados SSL existen
# ==============================================================================

- name: Verificar que certificados SSL existen
  stat:
    path: "{{ playbook_dir }}/../nginx/ssl/cert.pem"
  register: ssl_cert

- name: Informar si certificados SSL están listos
  debug:
    msg: "✅ Certificados SSL encontrados en ./nginx/ssl/"
  when: ssl_cert.stat.exists

- name: Advertencia si certificados SSL no existen
  debug:
    msg: "⚠️ Certificados SSL no encontrados. Los generó el rol ssl."
  when: not ssl_cert.stat.exists

# ==============================================================================
# PASO 5: Verificar que configuración nginx existe
# ==============================================================================

- name: Verificar que nginx/default.conf existe
  stat:
    path: "{{ playbook_dir }}/../nginx/default.conf"
  register: nginx_config

- name: Informar si nginx/default.conf existe
  debug:
    msg: "✅ Configuración nginx encontrada en ./nginx/default.conf"
  when: nginx_config.stat.exists

- name: Advertencia si nginx/default.conf no existe
  debug:
    msg: "Error ./nginx/default.conf no encontrado."
  when: not nginx_config.stat.exists

# ==============================================================================
# PASO 6: Levantar contenedores con docker-compose
# ==============================================================================

- name: Levantar contenedores Docker Compose
  shell: |
    cd {{ playbook_dir }}/..
    docker-compose up -d
  register: docker_compose_result
  # Genera todos los contenedores (mysql, wordpress, nginx, phpmyadmin)
  # Se ejecuta en el root del proyecto donde está docker-compose.yml

- name: Mostrar resultado
  debug:
    msg: "{{ docker_compose_result.stdout_lines }}"

# ==============================================================================
# PASO 7: Validar que los contenedores están corriendo
# ==============================================================================

- name: Verificar estado de contenedores
  command: docker ps -a
  register: docker_status
  changed_when: false
  # Muestra todos los contenedores con su estado

- name: Mostrar estado de contenedores
  debug:
    msg: "{{ docker_status.stdout_lines }}"
  # Verifica que todos los contenedores están corriendo

