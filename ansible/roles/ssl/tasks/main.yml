# SSL/TLS - Generaci√≥n de certificados para HTTPS
# Requisito Cloud-1: "Your server should be able, when possible, to use TLS"


# ==============================================================================
# PASO 1: Crear directorio para certificados
# ==============================================================================

- name: Crear directorio para certificados SSL
  file:
    path: "{{ remote_project_dir }}/nginx/ssl"
    state: directory
    mode: '0700'
  # Permisos restrictivos (solo root) por seguridad

# ==============================================================================
# PASO 2: Generar certificados autofirmados
# ==============================================================================

- name: Verificar si certificado ya existe
  stat:
    path: "{{ remote_project_dir }}/nginx/ssl/cert.pem"
  register: cert_file

- name: Generar certificado autofirmado (v√°lido 365 d√≠as)
  shell: |
    openssl req -x509 -newkey rsa:2048 \
      -keyout {{ remote_project_dir }}/nginx/ssl/key.pem \
      -out {{ remote_project_dir }}/nginx/ssl/cert.pem \
      -days 365 \
      -nodes \
      -subj "/C=ES/ST=Madrid/L=Madrid/O=42/OU=Cloud-1/CN=localhost"
  when: not cert_file.stat.exists
  # Solo genera si no existe
  # -x509: Certificado autofirmado
  # -newkey rsa:2048: Clave RSA 2048 bits
  # -days 365: V√°lido por 1 a√±o
  # -nodes: Sin contrase√±a
  # -subj: Datos del certificado (CN=localhost para desarrollo local)

- name: Mostrar informaci√≥n de certificado
  debug:
    msg:
      - "=========================================="
      - "‚úÖ Certificado SSL generado"
      - "=========================================="
      - ""
      - "üìç Ubicaci√≥n:"
      - "   - Certificado: ./nginx/ssl/cert.pem"
      - "   - Clave privada: ./nginx/ssl/key.pem"
      - ""
      - "‚ö†Ô∏è Nota de seguridad:"
      - "   Este es un certificado AUTOFIRMADO"
      - "   V√°lido para desarrollo y testing"
      - ""
      - "üìå Para producci√≥n (servidor remoto):"
      - "   Usar Let's Encrypt con certbot"
      - "   (Ser√° configurado autom√°ticamente)"
      - ""
      - "üîí HTTP ‚Üí HTTPS:"
      - "   Nginx redirige autom√°ticamente"
      - "=========================================="

# ==============================================================================
# PASO 3: Verificar que openssl est√° instalado
# ==============================================================================

- name: Verificar openssl disponible
  command: which openssl
  register: openssl_check
  changed_when: false
  failed_when: false

- name: Instalar openssl si no existe
  apt:
    name: openssl
    state: present
  when: openssl_check.rc != 0
  # openssl es necesario para generar certificados
